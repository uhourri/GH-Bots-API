[
    {
        "id": "32897573518",
        "type": "WatchEvent",
        "actor": {
            "id": 66859419,
            "login": "MicroCBer",
            "display_login": "MicroCBer",
            "gravatar_id": "",
            "url": "https://api.github.com/users/MicroCBer",
            "avatar_url": "https://avatars.githubusercontent.com/u/66859419?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T11:48:00Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32896915663",
        "type": "WatchEvent",
        "actor": {
            "id": 94276947,
            "login": "Nero0113",
            "display_login": "Nero0113",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Nero0113",
            "avatar_url": "https://avatars.githubusercontent.com/u/94276947?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T11:20:10Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32896638200",
        "type": "WatchEvent",
        "actor": {
            "id": 96833021,
            "login": "mmbwf",
            "display_login": "mmbwf",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mmbwf",
            "avatar_url": "https://avatars.githubusercontent.com/u/96833021?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T11:08:43Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32895492074",
        "type": "WatchEvent",
        "actor": {
            "id": 51090334,
            "login": "Sourland",
            "display_login": "Sourland",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Sourland",
            "avatar_url": "https://avatars.githubusercontent.com/u/51090334?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T10:21:59Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32894331629",
        "type": "IssuesEvent",
        "actor": {
            "id": 130363145,
            "login": "attkap",
            "display_login": "attkap",
            "gravatar_id": "",
            "url": "https://api.github.com/users/attkap",
            "avatar_url": "https://avatars.githubusercontent.com/u/130363145?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "closed",
            "issue": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/846",
                "repository_url": "https://api.github.com/repos/huggingface/trl",
                "labels_url": "https://api.github.com/repos/huggingface/trl/issues/846/labels{/name}",
                "comments_url": "https://api.github.com/repos/huggingface/trl/issues/846/comments",
                "events_url": "https://api.github.com/repos/huggingface/trl/issues/846/events",
                "html_url": "https://github.com/huggingface/trl/issues/846",
                "id": 1932030884,
                "node_id": "I_kwDODu56-85zKHOk",
                "number": 846,
                "title": "OOM error on 7B model  despite 4-bit quantization with 24GB VRAM",
                "user": {
                    "login": "attkap",
                    "id": 130363145,
                    "node_id": "U_kgDOB8UvCQ",
                    "avatar_url": "https://avatars.githubusercontent.com/u/130363145?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/attkap",
                    "html_url": "https://github.com/attkap",
                    "followers_url": "https://api.github.com/users/attkap/followers",
                    "following_url": "https://api.github.com/users/attkap/following{/other_user}",
                    "gists_url": "https://api.github.com/users/attkap/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/attkap/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/attkap/subscriptions",
                    "organizations_url": "https://api.github.com/users/attkap/orgs",
                    "repos_url": "https://api.github.com/users/attkap/repos",
                    "events_url": "https://api.github.com/users/attkap/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/attkap/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "closed",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 3,
                "created_at": "2023-10-08T19:31:24Z",
                "updated_at": "2023-10-27T09:37:57Z",
                "closed_at": "2023-10-27T09:37:56Z",
                "author_association": "NONE",
                "active_lock_reason": null,
                "body": "I've been trying to follow beginner's tutorials like:\r\nhttps://www.philschmid.de/instruction-tune-llama-2\r\nand\r\nhttps://medium.com/@qendelai/fine-tuning-mistral-7b-instruct-model-in-colab-a-beginners-guide-0f7bebccf11c (and many others), but I keep getting OOM errors, despite optimising heavily for memory.  What is weird is that when I follow the standard tutorials, I get OOM errors even with exactly the same setup (AWS EC2 g5.x4large) as in the tutorial.\r\n\r\nI've now finally got a training run to work with an A10 (24GB VRAM) and the script below.\r\nStill, this is taking up a full 16GB of VRAM and running very slowly.\r\n\r\nI'm using a per_device_train_batch_size of 2, with 4-bit quantised LoRA on reduced target modules and a max seq length of 2048. Can anyone explain to me why this setup is still so memory inefficient? \r\n\r\nAny advice would be deeply appreciated\ud83d\ude4f - I've been banging my head against this for a full day. \r\n\r\n### Code to Reproduce\r\n```python\r\nimport torch \r\nfrom trl import SFTTrainer\r\nfrom datasets import load_dataset \r\nfrom transformers import TrainingArguments, AutoTokenizer, BitsAndBytesConfig, AutoModelForCausalLM\r\nfrom peft import AutoPeftModelForCausalLM, LoraConfig, get_peft_model, prepare_model_for_kbit_training\r\n\r\n# Loading the dataset \r\ndataset = load_dataset(\"databricks/databricks-dolly-15k\", split=\"train\")\r\n\r\n# Filter QA pairs without context\r\ndataset = dataset.filter(lambda x:x['context'] == '')\r\n\r\n# A prompting formatting function \r\ndef create_prompt_instruction(sample):\r\n    return f\"\"\"### Instruction: \r\n    Use the input below to create an instruction, which could have been used to generate the input using an LLM. \r\n\r\n    ### Input \r\n    {sample['response']}\r\n\r\n    ### Response:\r\n    {sample['instruction']}\r\n    \"\"\"\r\n# Import model and tokenizer \r\nmodel = AutoModelForCausalLM.from_pretrained(\"mistralai/Mistral-7B-Instruct-v0.1\", device_map='auto', load_in_4bit=True, use_cache=False)\r\ntokenizer = AutoTokenizer.from_pretrained(\"mistralai/Mistral-7B-Instruct-v0.1\")\r\n\r\ntokenizer.pad_token = tokenizer.eos_token\r\ntokenizer.padding_side = \"right\"\r\n\r\n# PEFT Config \r\npeft_config = LoraConfig(\r\n    lora_alpha=16,\r\n    lora_dropout=0.1,\r\n    target_modules=[\"q_proj\", \"v_proj\", \"k_proj\", \"o_proj\"],\r\n    r=64,\r\n    bias=\"none\",\r\n    task_type=\"CAUSAL_LM\"\r\n)\r\n\r\n# Prepare the model for finetuning \r\nmodel = prepare_model_for_kbit_training(model)\r\nmodel = get_peft_model(model, peft_config)\r\n\r\n# Split dataset into 70% for training and 30% for testing \r\ndataset = dataset.train_test_split(test_size=0.3)\r\n\r\n# Use the train split for training \r\ntrain_dataset = dataset['train']\r\n\r\n# Define training arguments \r\nargs = TrainingArguments(\r\n    output_dir = \"mistral_instruct_qa\",\r\n    num_train_epochs = 5,\r\n    per_device_train_batch_size = 2,\r\n    warmup_steps = 0.03,\r\n    logging_steps=10,\r\n    save_strategy=\"epoch\",\r\n    learning_rate=2e-4,\r\n    bf16=True,\r\n    lr_scheduler_type='constant',\r\n    disable_tqdm=True\r\n)\r\n\r\n# Define SFTTrainer arguments \r\nmax_seq_length = 2048\r\n\r\ntrainer = SFTTrainer(\r\n    model=model,\r\n    peft_config=peft_config,\r\n    max_seq_length=max_seq_length,\r\n    tokenizer=tokenizer,\r\n    packing=True,\r\n    formatting_func=create_prompt_instruction,\r\n    args=args,\r\n    train_dataset=train_dataset,\r\n)\r\n\r\n# Kick off the finetuning job \r\ntrainer.train()\r\n\r\n# Save finetuned model \r\ntrainer.save_model(\"mistral_instruct_qa\")\r\n",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/846/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/huggingface/trl/issues/846/timeline",
                "performed_via_github_app": null,
                "state_reason": "completed"
            }
        },
        "public": true,
        "created_at": "2023-10-27T09:37:58Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32894331500",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 130363145,
            "login": "attkap",
            "display_login": "attkap",
            "gravatar_id": "",
            "url": "https://api.github.com/users/attkap",
            "avatar_url": "https://avatars.githubusercontent.com/u/130363145?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/846",
                "repository_url": "https://api.github.com/repos/huggingface/trl",
                "labels_url": "https://api.github.com/repos/huggingface/trl/issues/846/labels{/name}",
                "comments_url": "https://api.github.com/repos/huggingface/trl/issues/846/comments",
                "events_url": "https://api.github.com/repos/huggingface/trl/issues/846/events",
                "html_url": "https://github.com/huggingface/trl/issues/846",
                "id": 1932030884,
                "node_id": "I_kwDODu56-85zKHOk",
                "number": 846,
                "title": "OOM error on 7B model  despite 4-bit quantization with 24GB VRAM",
                "user": {
                    "login": "attkap",
                    "id": 130363145,
                    "node_id": "U_kgDOB8UvCQ",
                    "avatar_url": "https://avatars.githubusercontent.com/u/130363145?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/attkap",
                    "html_url": "https://github.com/attkap",
                    "followers_url": "https://api.github.com/users/attkap/followers",
                    "following_url": "https://api.github.com/users/attkap/following{/other_user}",
                    "gists_url": "https://api.github.com/users/attkap/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/attkap/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/attkap/subscriptions",
                    "organizations_url": "https://api.github.com/users/attkap/orgs",
                    "repos_url": "https://api.github.com/users/attkap/repos",
                    "events_url": "https://api.github.com/users/attkap/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/attkap/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "closed",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 3,
                "created_at": "2023-10-08T19:31:24Z",
                "updated_at": "2023-10-27T09:37:57Z",
                "closed_at": "2023-10-27T09:37:56Z",
                "author_association": "NONE",
                "active_lock_reason": null,
                "body": "I've been trying to follow beginner's tutorials like:\r\nhttps://www.philschmid.de/instruction-tune-llama-2\r\nand\r\nhttps://medium.com/@qendelai/fine-tuning-mistral-7b-instruct-model-in-colab-a-beginners-guide-0f7bebccf11c (and many others), but I keep getting OOM errors, despite optimising heavily for memory.  What is weird is that when I follow the standard tutorials, I get OOM errors even with exactly the same setup (AWS EC2 g5.x4large) as in the tutorial.\r\n\r\nI've now finally got a training run to work with an A10 (24GB VRAM) and the script below.\r\nStill, this is taking up a full 16GB of VRAM and running very slowly.\r\n\r\nI'm using a per_device_train_batch_size of 2, with 4-bit quantised LoRA on reduced target modules and a max seq length of 2048. Can anyone explain to me why this setup is still so memory inefficient? \r\n\r\nAny advice would be deeply appreciated\ud83d\ude4f - I've been banging my head against this for a full day. \r\n\r\n### Code to Reproduce\r\n```python\r\nimport torch \r\nfrom trl import SFTTrainer\r\nfrom datasets import load_dataset \r\nfrom transformers import TrainingArguments, AutoTokenizer, BitsAndBytesConfig, AutoModelForCausalLM\r\nfrom peft import AutoPeftModelForCausalLM, LoraConfig, get_peft_model, prepare_model_for_kbit_training\r\n\r\n# Loading the dataset \r\ndataset = load_dataset(\"databricks/databricks-dolly-15k\", split=\"train\")\r\n\r\n# Filter QA pairs without context\r\ndataset = dataset.filter(lambda x:x['context'] == '')\r\n\r\n# A prompting formatting function \r\ndef create_prompt_instruction(sample):\r\n    return f\"\"\"### Instruction: \r\n    Use the input below to create an instruction, which could have been used to generate the input using an LLM. \r\n\r\n    ### Input \r\n    {sample['response']}\r\n\r\n    ### Response:\r\n    {sample['instruction']}\r\n    \"\"\"\r\n# Import model and tokenizer \r\nmodel = AutoModelForCausalLM.from_pretrained(\"mistralai/Mistral-7B-Instruct-v0.1\", device_map='auto', load_in_4bit=True, use_cache=False)\r\ntokenizer = AutoTokenizer.from_pretrained(\"mistralai/Mistral-7B-Instruct-v0.1\")\r\n\r\ntokenizer.pad_token = tokenizer.eos_token\r\ntokenizer.padding_side = \"right\"\r\n\r\n# PEFT Config \r\npeft_config = LoraConfig(\r\n    lora_alpha=16,\r\n    lora_dropout=0.1,\r\n    target_modules=[\"q_proj\", \"v_proj\", \"k_proj\", \"o_proj\"],\r\n    r=64,\r\n    bias=\"none\",\r\n    task_type=\"CAUSAL_LM\"\r\n)\r\n\r\n# Prepare the model for finetuning \r\nmodel = prepare_model_for_kbit_training(model)\r\nmodel = get_peft_model(model, peft_config)\r\n\r\n# Split dataset into 70% for training and 30% for testing \r\ndataset = dataset.train_test_split(test_size=0.3)\r\n\r\n# Use the train split for training \r\ntrain_dataset = dataset['train']\r\n\r\n# Define training arguments \r\nargs = TrainingArguments(\r\n    output_dir = \"mistral_instruct_qa\",\r\n    num_train_epochs = 5,\r\n    per_device_train_batch_size = 2,\r\n    warmup_steps = 0.03,\r\n    logging_steps=10,\r\n    save_strategy=\"epoch\",\r\n    learning_rate=2e-4,\r\n    bf16=True,\r\n    lr_scheduler_type='constant',\r\n    disable_tqdm=True\r\n)\r\n\r\n# Define SFTTrainer arguments \r\nmax_seq_length = 2048\r\n\r\ntrainer = SFTTrainer(\r\n    model=model,\r\n    peft_config=peft_config,\r\n    max_seq_length=max_seq_length,\r\n    tokenizer=tokenizer,\r\n    packing=True,\r\n    formatting_func=create_prompt_instruction,\r\n    args=args,\r\n    train_dataset=train_dataset,\r\n)\r\n\r\n# Kick off the finetuning job \r\ntrainer.train()\r\n\r\n# Save finetuned model \r\ntrainer.save_model(\"mistral_instruct_qa\")\r\n",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/846/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/huggingface/trl/issues/846/timeline",
                "performed_via_github_app": null,
                "state_reason": "completed"
            },
            "comment": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1782609387",
                "html_url": "https://github.com/huggingface/trl/issues/846#issuecomment-1782609387",
                "issue_url": "https://api.github.com/repos/huggingface/trl/issues/846",
                "id": 1782609387,
                "node_id": "IC_kwDODu56-85qQHXr",
                "user": {
                    "login": "attkap",
                    "id": 130363145,
                    "node_id": "U_kgDOB8UvCQ",
                    "avatar_url": "https://avatars.githubusercontent.com/u/130363145?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/attkap",
                    "html_url": "https://github.com/attkap",
                    "followers_url": "https://api.github.com/users/attkap/followers",
                    "following_url": "https://api.github.com/users/attkap/following{/other_user}",
                    "gists_url": "https://api.github.com/users/attkap/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/attkap/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/attkap/subscriptions",
                    "organizations_url": "https://api.github.com/users/attkap/orgs",
                    "repos_url": "https://api.github.com/users/attkap/repos",
                    "events_url": "https://api.github.com/users/attkap/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/attkap/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2023-10-27T09:37:57Z",
                "updated_at": "2023-10-27T09:37:57Z",
                "author_association": "NONE",
                "body": "Hi all, thanks for the responses. Indeed, I believe the issue was with setting gradient_checkpointing=True. Thanks for the help!",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1782609387/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2023-10-27T09:37:57Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32894169334",
        "type": "WatchEvent",
        "actor": {
            "id": 43147663,
            "login": "simonweniger",
            "display_login": "simonweniger",
            "gravatar_id": "",
            "url": "https://api.github.com/users/simonweniger",
            "avatar_url": "https://avatars.githubusercontent.com/u/43147663?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T09:31:53Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32889863176",
        "type": "WatchEvent",
        "actor": {
            "id": 51508525,
            "login": "feidie666",
            "display_login": "feidie666",
            "gravatar_id": "",
            "url": "https://api.github.com/users/feidie666",
            "avatar_url": "https://avatars.githubusercontent.com/u/51508525?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T06:34:23Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32889642733",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 8408100,
            "login": "jackstaff",
            "display_login": "jackstaff",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jackstaff",
            "avatar_url": "https://avatars.githubusercontent.com/u/8408100?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/904",
                "repository_url": "https://api.github.com/repos/huggingface/trl",
                "labels_url": "https://api.github.com/repos/huggingface/trl/issues/904/labels{/name}",
                "comments_url": "https://api.github.com/repos/huggingface/trl/issues/904/comments",
                "events_url": "https://api.github.com/repos/huggingface/trl/issues/904/events",
                "html_url": "https://github.com/huggingface/trl/pull/904",
                "id": 1955987790,
                "node_id": "PR_kwDODu56-85dd_7o",
                "number": 904,
                "title": "[NEFTune] Replace absolute noise with proportional noise",
                "user": {
                    "login": "jackstaff",
                    "id": 8408100,
                    "node_id": "MDQ6VXNlcjg0MDgxMDA=",
                    "avatar_url": "https://avatars.githubusercontent.com/u/8408100?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/jackstaff",
                    "html_url": "https://github.com/jackstaff",
                    "followers_url": "https://api.github.com/users/jackstaff/followers",
                    "following_url": "https://api.github.com/users/jackstaff/following{/other_user}",
                    "gists_url": "https://api.github.com/users/jackstaff/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/jackstaff/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/jackstaff/subscriptions",
                    "organizations_url": "https://api.github.com/users/jackstaff/orgs",
                    "repos_url": "https://api.github.com/users/jackstaff/repos",
                    "events_url": "https://api.github.com/users/jackstaff/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/jackstaff/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "closed",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 6,
                "created_at": "2023-10-22T17:35:32Z",
                "updated_at": "2023-10-27T06:22:21Z",
                "closed_at": "2023-10-26T06:05:26Z",
                "author_association": "NONE",
                "active_lock_reason": null,
                "draft": false,
                "pull_request": {
                    "url": "https://api.github.com/repos/huggingface/trl/pulls/904",
                    "html_url": "https://github.com/huggingface/trl/pull/904",
                    "diff_url": "https://github.com/huggingface/trl/pull/904.diff",
                    "patch_url": "https://github.com/huggingface/trl/pull/904.patch",
                    "merged_at": null
                },
                "body": "Generally speaking, using proportional noise is better than absolute noise for embedding layers.",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/904/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/huggingface/trl/issues/904/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1782363458",
                "html_url": "https://github.com/huggingface/trl/pull/904#issuecomment-1782363458",
                "issue_url": "https://api.github.com/repos/huggingface/trl/issues/904",
                "id": 1782363458,
                "node_id": "IC_kwDODu56-85qPLVC",
                "user": {
                    "login": "jackstaff",
                    "id": 8408100,
                    "node_id": "MDQ6VXNlcjg0MDgxMDA=",
                    "avatar_url": "https://avatars.githubusercontent.com/u/8408100?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/jackstaff",
                    "html_url": "https://github.com/jackstaff",
                    "followers_url": "https://api.github.com/users/jackstaff/followers",
                    "following_url": "https://api.github.com/users/jackstaff/following{/other_user}",
                    "gists_url": "https://api.github.com/users/jackstaff/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/jackstaff/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/jackstaff/subscriptions",
                    "organizations_url": "https://api.github.com/users/jackstaff/orgs",
                    "repos_url": "https://api.github.com/users/jackstaff/repos",
                    "events_url": "https://api.github.com/users/jackstaff/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/jackstaff/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2023-10-27T06:22:20Z",
                "updated_at": "2023-10-27T06:22:20Z",
                "author_association": "NONE",
                "body": "I created repository for verify:  [Direct Data Augmentation](https://github.com/jackstaff/dda)\r\n\r\nJust for the record:\r\n----------------------------------------------------------------------------------------------------------------------\r\nFrom:  \"Neel Jain\"<[njain17@umd.edu](mailto:njain17@umd.edu)>;\r\nDate:  Thu, Oct 26, 2023 09:27 AM\r\nTo:  \"reco\"<[reco@jackstaff.org](mailto:reco@jackstaff.org)>;\r\nSubject:  Re: Fw:Re: [huggingface/trl] [NEFTune] Replace absolute noise with proportional noise (PR #904)\r\n \r\nHello Reco,\r\n\r\nThis is an interesting idea and worth trying. We used our scaling rules from FreeLB, which is robust optimization technique. I think your idea might be good, but it\u2019s hard to know without empirical evidence.\r\n\r\nBest,\r\nNeel Jain\r\n\r\nOn Wed, Oct 25, 2023 at 4:50\u202fAM reco <[reco@jackstaff.org](mailto:reco@jackstaff.org)> wrote:\r\nDear Neel Jain,\r\n\r\nI hope this email finds you well.\r\n\r\nI recently read the relevant information on NEFTune, and I was very impressed by its conceptual brilliance.\r\n\r\nIn particular, I was wondering if you have considered setting the neftune_alpha parameter to proportional noise. This could be done by simply changing the following line of code in train.py:\r\nFROM:\r\n        data['inputs_embeds'] = embeds_init + delta\r\nTO:\r\n       data['inputs_embeds'] = embeds_init*(1+proportion_delta)\r\n\r\nThis would ensure that the added noise is a perturbation of the input data, with the maximum amplitude of each data perturbation controlled by the proportional hyperparameter. This approach, in my opinion, offers several advantages over the absolute value-based hyperparameter setting used in the paper:\r\n\r\nIt is more intuitive and easier to understand, as it can be interpreted as a deviation from the input data.\r\nIt is more robust to changes in the input data, as the maximum amplitude of the noise is always relative to the input data.\r\nIt may allow for finer-grained control over the amount of noise added to the data, as the proportional hyperparameter can be adjusted in smaller increments.\r\n(By adjusting the neftune_alpha parameter from small to large, we can even see the process of the model from overfitting to underfitting.)\r\n\r\nI have not had the opportunity to test this approach myself, but I am curious to see how it performs in practice. I would be grateful for any feedback you have on this idea.\r\n\r\nThank you for your time and consideration.\r\n\r\n\r\nBest Regards.\r\nReco.\r\n\r\n\r\nCode Reference:\r\nFROM:\r\n        dims = torch.tensor(embeds_init.size(1) * embeds_init.size(2))\r\n        mag_norm = args.neftune_alpha / torch.sqrt(dims)\r\n        embeds= embeds_init+ torch.zeros_like(embeds_init).uniform_(-mag_norm, mag_norm)\r\n\r\nTO:\r\n        embeds= embeds_init*(1+ torch.zeros_like(embeds_init).uniform_(-args.neftune_alpha, args.neftune_alpha))\r\n \r\n------------------ Original ------------------\r\nFrom:  \"Leandro von Werra\"<[notifications@github.com](mailto:notifications@github.com)>;\r\nDate:  Tue, Oct 24, 2023 08:15 PM\r\nTo:  \"huggingface/trl\"<[trl@noreply.github.com](mailto:trl@noreply.github.com)>;\r\nCc:  \"reco\"<[reco@jackstaff.org](mailto:reco@jackstaff.org)>; \"Author\"<[author@noreply.github.com](mailto:author@noreply.github.com)>;\r\nSubject:  Re: [huggingface/trl] [NEFTune] Replace absolute noise with proportional noise (PR #904)\r\n \r\nI only saw the absolute approach discussed in the paper - do you have evidence that proportional noise is better?\r\n\r\n\u2014\r\nReply to this email directly, [view it on GitHub](https://github.com/huggingface/trl/pull/904#issuecomment-1777091890), or [unsubscribe](https://github.com/notifications/unsubscribe-auth/ACAEYJGNDL7FPZL7R25OGVDYA6WOLAVCNFSM6AAAAAA6LBMOH6VHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTONZXGA4TCOBZGA).\r\nYou are receiving this because you authored the thread.",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1782363458/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2023-10-27T06:22:21Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32889580019",
        "type": "WatchEvent",
        "actor": {
            "id": 22527230,
            "login": "Xiaoyang-Wang",
            "display_login": "Xiaoyang-Wang",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Xiaoyang-Wang",
            "avatar_url": "https://avatars.githubusercontent.com/u/22527230?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T06:19:01Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32889266761",
        "type": "WatchEvent",
        "actor": {
            "id": 117598871,
            "login": "mzweshmacua5",
            "display_login": "mzweshmacua5",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mzweshmacua5",
            "avatar_url": "https://avatars.githubusercontent.com/u/117598871?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T06:01:08Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32886396753",
        "type": "WatchEvent",
        "actor": {
            "id": 1930282,
            "login": "breadbread1984",
            "display_login": "breadbread1984",
            "gravatar_id": "",
            "url": "https://api.github.com/users/breadbread1984",
            "avatar_url": "https://avatars.githubusercontent.com/u/1930282?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T02:22:33Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32886221696",
        "type": "WatchEvent",
        "actor": {
            "id": 45775851,
            "login": "longruiqi",
            "display_login": "longruiqi",
            "gravatar_id": "",
            "url": "https://api.github.com/users/longruiqi",
            "avatar_url": "https://avatars.githubusercontent.com/u/45775851?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T02:08:52Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32886025835",
        "type": "WatchEvent",
        "actor": {
            "id": 18309021,
            "login": "oxfordxiao",
            "display_login": "oxfordxiao",
            "gravatar_id": "",
            "url": "https://api.github.com/users/oxfordxiao",
            "avatar_url": "https://avatars.githubusercontent.com/u/18309021?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-27T01:54:19Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32885658238",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 141143059,
            "login": "cuongtran-uva",
            "display_login": "cuongtran-uva",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cuongtran-uva",
            "avatar_url": "https://avatars.githubusercontent.com/u/141143059?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/871",
                "repository_url": "https://api.github.com/repos/huggingface/trl",
                "labels_url": "https://api.github.com/repos/huggingface/trl/issues/871/labels{/name}",
                "comments_url": "https://api.github.com/repos/huggingface/trl/issues/871/comments",
                "events_url": "https://api.github.com/repos/huggingface/trl/issues/871/events",
                "html_url": "https://github.com/huggingface/trl/pull/871",
                "id": 1942183546,
                "node_id": "PR_kwDODu56-85cwHRm",
                "number": 871,
                "title": "[`SFTTrainer`] Adds NEFTune into `SFTTrainer`",
                "user": {
                    "login": "younesbelkada",
                    "id": 49240599,
                    "node_id": "MDQ6VXNlcjQ5MjQwNTk5",
                    "avatar_url": "https://avatars.githubusercontent.com/u/49240599?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/younesbelkada",
                    "html_url": "https://github.com/younesbelkada",
                    "followers_url": "https://api.github.com/users/younesbelkada/followers",
                    "following_url": "https://api.github.com/users/younesbelkada/following{/other_user}",
                    "gists_url": "https://api.github.com/users/younesbelkada/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/younesbelkada/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/younesbelkada/subscriptions",
                    "organizations_url": "https://api.github.com/users/younesbelkada/orgs",
                    "repos_url": "https://api.github.com/users/younesbelkada/repos",
                    "events_url": "https://api.github.com/users/younesbelkada/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/younesbelkada/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "closed",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 6,
                "created_at": "2023-10-13T15:37:59Z",
                "updated_at": "2023-10-27T01:26:25Z",
                "closed_at": "2023-10-17T04:58:06Z",
                "author_association": "COLLABORATOR",
                "active_lock_reason": null,
                "draft": false,
                "pull_request": {
                    "url": "https://api.github.com/repos/huggingface/trl/pulls/871",
                    "html_url": "https://github.com/huggingface/trl/pull/871",
                    "diff_url": "https://github.com/huggingface/trl/pull/871.diff",
                    "patch_url": "https://github.com/huggingface/trl/pull/871.patch",
                    "merged_at": "2023-10-17T04:58:06Z"
                },
                "body": "# What does this PR do?\r\n\r\nThis PR adds NEFTune: a new technique for enhancing Supervised fine-tuning results results proposed in: https://arxiv.org/abs/2310.05914\r\n\r\n![Screenshot 2023-10-13 at 17 36 38](https://github.com/huggingface/trl/assets/49240599/81995c1d-16c3-4cfc-9fbc-0701a9a87531)\r\n\r\n\r\nI propose a very simple API which is as simple as passing a valid `neftune_noise_alpha` argument when initializing the `SFTTrainer`. To avoid any surprising behaviour, we should revert to the original forward method at the end of the training. This is handled inside `def train()` that is a wrapper around `Trainer`'s `train` method. \r\n\r\n```python\r\nfrom datasets import load_dataset\r\nfrom trl import SFTTrainer\r\n\r\ndataset = load_dataset(\"imdb\", split=\"train\")\r\n\r\ntrainer = SFTTrainer(\r\n    \"facebook/opt-350m\",\r\n    train_dataset=dataset,\r\n    dataset_text_field=\"text\",\r\n    max_seq_length=512,\r\n    neftune_noise_alpha=5,\r\n)\r\ntrainer.train()\r\n```\r\n\r\nI still need to add few lines in the documentation. \r\n\r\nFixes: https://github.com/huggingface/trl/issues/870\r\n\r\ncc @lvwerra @neelsjain @YuxinWenRick",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/871/reactions",
                    "total_count": 4,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 4,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/huggingface/trl/issues/871/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1782149799",
                "html_url": "https://github.com/huggingface/trl/pull/871#issuecomment-1782149799",
                "issue_url": "https://api.github.com/repos/huggingface/trl/issues/871",
                "id": 1782149799,
                "node_id": "IC_kwDODu56-85qOXKn",
                "user": {
                    "login": "cuongtran-uva",
                    "id": 141143059,
                    "node_id": "U_kgDOCGmsEw",
                    "avatar_url": "https://avatars.githubusercontent.com/u/141143059?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/cuongtran-uva",
                    "html_url": "https://github.com/cuongtran-uva",
                    "followers_url": "https://api.github.com/users/cuongtran-uva/followers",
                    "following_url": "https://api.github.com/users/cuongtran-uva/following{/other_user}",
                    "gists_url": "https://api.github.com/users/cuongtran-uva/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/cuongtran-uva/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/cuongtran-uva/subscriptions",
                    "organizations_url": "https://api.github.com/users/cuongtran-uva/orgs",
                    "repos_url": "https://api.github.com/users/cuongtran-uva/repos",
                    "events_url": "https://api.github.com/users/cuongtran-uva/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/cuongtran-uva/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2023-10-27T01:26:25Z",
                "updated_at": "2023-10-27T01:26:25Z",
                "author_association": "NONE",
                "body": "> @imrankh46 that feature is not merged yet in TRL main branch to use it please run:\r\n> \r\n> ```shell\r\n> pip install -U git+https://github.com/huggingface/trl.git@add-neftune\r\n> ```\r\n> \r\n> @BenjaminBossan , yes this is possible indeed and I think it is cleaner, however I found it easier to understand for future users to have a standalone forward method. Would it also hurt existing hooks that accelerate attaches in case we manipulate forward post hooks?\r\n\r\nI tried to update the trl  with neftune by using your command but it was unsuccessful. \r\n \r\n```\r\nCloning https://github.com/huggingface/trl.git (to revision add-neftune) to /tmp/pip-req-build-copawfzq\r\n  Running command git clone --quiet https://github.com/huggingface/trl.git /tmp/pip-req-build-copawfzq\r\n  WARNING: Did not find branch or tag 'add-neftune', assuming revision or ref.\r\n  Running command git checkout -q add-neftune\r\n  error: pathspec 'add-neftune' did not match any file(s) known to git.\r\n  error: subprocess-exited-with-error\r\n```\r\n",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1782149799/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2023-10-27T01:26:25Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32883825309",
        "type": "WatchEvent",
        "actor": {
            "id": 7548882,
            "login": "wrapss",
            "display_login": "wrapss",
            "gravatar_id": "",
            "url": "https://api.github.com/users/wrapss",
            "avatar_url": "https://avatars.githubusercontent.com/u/7548882?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T23:00:36Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32879933050",
        "type": "WatchEvent",
        "actor": {
            "id": 44650320,
            "login": "marait123",
            "display_login": "marait123",
            "gravatar_id": "",
            "url": "https://api.github.com/users/marait123",
            "avatar_url": "https://avatars.githubusercontent.com/u/44650320?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T19:35:44Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32878992265",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 31748898,
            "login": "Emerald01",
            "display_login": "Emerald01",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Emerald01",
            "avatar_url": "https://avatars.githubusercontent.com/u/31748898?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/872",
                "repository_url": "https://api.github.com/repos/huggingface/trl",
                "labels_url": "https://api.github.com/repos/huggingface/trl/issues/872/labels{/name}",
                "comments_url": "https://api.github.com/repos/huggingface/trl/issues/872/comments",
                "events_url": "https://api.github.com/repos/huggingface/trl/issues/872/events",
                "html_url": "https://github.com/huggingface/trl/issues/872",
                "id": 1942801300,
                "node_id": "I_kwDODu56-85zzMuU",
                "number": 872,
                "title": "DPO appears overwriting previous Lora layer from SFT in dpo_llama2.py?",
                "user": {
                    "login": "Emerald01",
                    "id": 31748898,
                    "node_id": "MDQ6VXNlcjMxNzQ4ODk4",
                    "avatar_url": "https://avatars.githubusercontent.com/u/31748898?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/Emerald01",
                    "html_url": "https://github.com/Emerald01",
                    "followers_url": "https://api.github.com/users/Emerald01/followers",
                    "following_url": "https://api.github.com/users/Emerald01/following{/other_user}",
                    "gists_url": "https://api.github.com/users/Emerald01/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/Emerald01/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/Emerald01/subscriptions",
                    "organizations_url": "https://api.github.com/users/Emerald01/orgs",
                    "repos_url": "https://api.github.com/users/Emerald01/repos",
                    "events_url": "https://api.github.com/users/Emerald01/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/Emerald01/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "open",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 2,
                "created_at": "2023-10-14T00:00:18Z",
                "updated_at": "2023-10-26T18:55:24Z",
                "closed_at": null,
                "author_association": "NONE",
                "active_lock_reason": null,
                "body": "Hello,\r\n\r\nI am trying to confirm that the following script is running as we expect. And I am simply following the two step procedure for DPO training here: https://github.com/huggingface/trl/blob/main/examples/research_projects/stack_llama_2/scripts/README.md\r\n\r\nI think for DPO part, loading model includes two steps:\r\n(1) We load the model checkpoint after supervised FT with Lora layers\r\nhttps://github.com/huggingface/trl/blob/main/examples/research_projects/stack_llama_2/scripts/dpo_llama2.py#L127\r\n\r\nIt is like this:\r\n```\r\nsft_model = AutoPeftModelForCausalLM.from_pretrained(\r\n        script_args.model_name_or_path,\r\n        low_cpu_mem_usage=True,\r\n        torch_dtype=torch.float16,\r\n        load_in_4bit=True,\r\n    )\r\n```\r\n(2) Then we call DPOTrainer, inside of it, we have this model adding a new peft configure to form a new model target\r\nhttps://github.com/huggingface/trl/blob/main/trl/trainer/dpo_trainer.py#L138C13-L138C55\r\n\r\nIt is like this\r\n```\r\ndpo_model = get_peft_model(sft_model, peft_config)\r\n```\r\n\r\nThe problem is that, if I understand right, this second `peft_config` seems overwriting the previous lora layer learned by the `sft_model`, if that is the case, it essentially suggests that the SFT step is overwritten by DPO Trainer constructor without any effect then. \r\n\r\nTo confirm this, I simply do this\r\n\r\nFirst, I load my SFT final_checkpoint\r\n```\r\nsft_model = AutoPeftModelForCausalLM.from_pretrained(\r\n        \"XXXXXXXX/sft/final_checkpoint/\",\r\n        low_cpu_mem_usage=True,\r\n        torch_dtype=torch.float16,\r\n        load_in_4bit=True,\r\n    )\r\n```\r\nYou can see that I am using a Lora layer with rank 4, everything is good\r\n```\r\nPeftModelForCausalLM(\r\n  (base_model): LoraModel(\r\n    (model): LlamaForCausalLM(\r\n      (model): LlamaModel(\r\n        (embed_tokens): Embedding(32000, 4096)\r\n        (layers): ModuleList(\r\n          (0-31): 32 x LlamaDecoderLayer(\r\n            (self_attn): LlamaAttention(\r\n              (q_proj): Linear4bit(\r\n                in_features=4096, out_features=4096, bias=False\r\n                (lora_dropout): ModuleDict(\r\n                  (default): Dropout(p=0.05, inplace=False)\r\n                )\r\n                (lora_A): ModuleDict(\r\n                  (default): Linear(in_features=4096, out_features=4, bias=False)\r\n                )\r\n                (lora_B): ModuleDict(\r\n                  (default): Linear(in_features=4, out_features=4096, bias=False)\r\n                )\r\n                (lora_embedding_A): ParameterDict()\r\n                (lora_embedding_B): ParameterDict()\r\n              )\r\n              (k_proj): Linear4bit(in_features=4096, out_features=4096, bias=False)\r\n              (v_proj): Linear4bit(\r\n                in_features=4096, out_features=4096, bias=False\r\n                (lora_dropout): ModuleDict(\r\n                  (default): Dropout(p=0.05, inplace=False)\r\n                )\r\n                (lora_A): ModuleDict(\r\n                  (default): Linear(in_features=4096, out_features=4, bias=False)\r\n                )\r\n                (lora_B): ModuleDict(\r\n                  (default): Linear(in_features=4, out_features=4096, bias=False)\r\n                )\r\n                (lora_embedding_A): ParameterDict()\r\n                (lora_embedding_B): ParameterDict()\r\n              )\r\n              (o_proj): Linear4bit(in_features=4096, out_features=4096, bias=False)\r\n              (rotary_emb): LlamaRotaryEmbedding()\r\n            )\r\n            (mlp): LlamaMLP(\r\n              (gate_proj): Linear4bit(in_features=4096, out_features=11008, bias=False)\r\n              (up_proj): Linear4bit(in_features=4096, out_features=11008, bias=False)\r\n              (down_proj): Linear4bit(in_features=11008, out_features=4096, bias=False)\r\n              (act_fn): SiLUActivation()\r\n            )\r\n            (input_layernorm): LlamaRMSNorm()\r\n            (post_attention_layernorm): LlamaRMSNorm()\r\n          )\r\n        )\r\n        (norm): LlamaRMSNorm()\r\n      )\r\n      (lm_head): Linear(in_features=4096, out_features=32000, bias=False)\r\n    )\r\n  )\r\n)\r\n```\r\nI can print out a few simple statistics of any lora layer to see the numbers\r\n```\r\nIn: sft_model.base_model.model.model.layers[5].self_attn.q_proj.lora_A.default.weight.mean()\r\nOut: tensor(-0.0002, device='cuda:0')\r\n\r\nIn: sft_model.base_model.model.model.layers[5].self_attn.q_proj.lora_A.default.weight.std()\r\nOut: tensor(0.0100, device='cuda:0')\r\n```\r\nNow if I follow what `DPOTrainer` is doing, let me provide a new lora configure of the same structure as we used for SFTTrainer (I try to include different target_modules, it does not change any picture as I confirmed). So for simplicity, I just provide the same lora configure as being used in SFTTrainer stage.\r\n```\r\npeft_config = LoraConfig(\r\n        r=4,\r\n        lora_alpha=16,\r\n        lora_dropout=0.05,\r\n        target_modules=[\r\n            \"q_proj\",\r\n            \"v_proj\",\r\n        ],\r\n        bias=\"none\",\r\n        task_type=\"CAUSAL_LM\",\r\n    )\r\n```\r\nAnd we call peft construction as DPOTrainer does\r\n```\r\ndpo_model = get_peft_model(sft_model, peft_config)\r\n```\r\nNow if you check the same layer, it gives\r\n```\r\nIn: dpo_model.base_model.base_model.model.model.layers[5].self_attn.q_proj.lora_A.default.weight.mean()\r\nOut: tensor(3.8875e-05, device='cuda:0', grad_fn=<MeanBackward0>)\r\nIn: dpo_model.base_model.base_model.model.model.layers[5].self_attn.q_proj.lora_A.default.weight.std()\r\nOut: tensor(0.0090, device='cuda:0', grad_fn=<StdBackward0>)\r\n```\r\nIt appears that the original lora layer of `sft_model` has been replaced with a newly initialized weights. My thought would be, it will either keep the same Lora layer untouched and learn on top of it. Do I misunderstand anything or miss any important step during constructing the model?\r\n\r\nOtherwise SFT step is essentially doing nothing. I hope I am doing something wrong somewhere, otherwise, this is a big bug.\r\n\r\n\r\n\r\n",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/872/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/huggingface/trl/issues/872/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1781716559",
                "html_url": "https://github.com/huggingface/trl/issues/872#issuecomment-1781716559",
                "issue_url": "https://api.github.com/repos/huggingface/trl/issues/872",
                "id": 1781716559,
                "node_id": "IC_kwDODu56-85qMtZP",
                "user": {
                    "login": "Emerald01",
                    "id": 31748898,
                    "node_id": "MDQ6VXNlcjMxNzQ4ODk4",
                    "avatar_url": "https://avatars.githubusercontent.com/u/31748898?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/Emerald01",
                    "html_url": "https://github.com/Emerald01",
                    "followers_url": "https://api.github.com/users/Emerald01/followers",
                    "following_url": "https://api.github.com/users/Emerald01/following{/other_user}",
                    "gists_url": "https://api.github.com/users/Emerald01/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/Emerald01/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/Emerald01/subscriptions",
                    "organizations_url": "https://api.github.com/users/Emerald01/orgs",
                    "repos_url": "https://api.github.com/users/Emerald01/repos",
                    "events_url": "https://api.github.com/users/Emerald01/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/Emerald01/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2023-10-26T18:55:23Z",
                "updated_at": "2023-10-26T18:55:23Z",
                "author_association": "NONE",
                "body": "Wondering if there is any conclusion here? Should I merge the lora weight to the base to form the new model and then add a new lora layer at DPO stage? Anyway, I think running the example directly could be problematic, just want to confirm. Thank you. @younesbelkada @kashif @lvwerra ",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1781716559/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2023-10-26T18:55:24Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32877364632",
        "type": "WatchEvent",
        "actor": {
            "id": 60238938,
            "login": "MohamedOuhami",
            "display_login": "MohamedOuhami",
            "gravatar_id": "",
            "url": "https://api.github.com/users/MohamedOuhami",
            "avatar_url": "https://avatars.githubusercontent.com/u/60238938?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T17:48:38Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32875268012",
        "type": "WatchEvent",
        "actor": {
            "id": 1573602,
            "login": "nguoithichkhampha",
            "display_login": "nguoithichkhampha",
            "gravatar_id": "",
            "url": "https://api.github.com/users/nguoithichkhampha",
            "avatar_url": "https://avatars.githubusercontent.com/u/1573602?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T16:25:24Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32875136016",
        "type": "WatchEvent",
        "actor": {
            "id": 22076188,
            "login": "paulpaul91",
            "display_login": "paulpaul91",
            "gravatar_id": "",
            "url": "https://api.github.com/users/paulpaul91",
            "avatar_url": "https://avatars.githubusercontent.com/u/22076188?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T16:20:28Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32873724278",
        "type": "ForkEvent",
        "actor": {
            "id": 41106123,
            "login": "ankit1063",
            "display_login": "ankit1063",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ankit1063",
            "avatar_url": "https://avatars.githubusercontent.com/u/41106123?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "forkee": {
                "id": 710384740,
                "node_id": "R_kgDOKlecZA",
                "name": "trl",
                "full_name": "ankit1063/trl",
                "private": false,
                "owner": {
                    "login": "ankit1063",
                    "id": 41106123,
                    "node_id": "MDQ6VXNlcjQxMTA2MTIz",
                    "avatar_url": "https://avatars.githubusercontent.com/u/41106123?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/ankit1063",
                    "html_url": "https://github.com/ankit1063",
                    "followers_url": "https://api.github.com/users/ankit1063/followers",
                    "following_url": "https://api.github.com/users/ankit1063/following{/other_user}",
                    "gists_url": "https://api.github.com/users/ankit1063/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/ankit1063/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/ankit1063/subscriptions",
                    "organizations_url": "https://api.github.com/users/ankit1063/orgs",
                    "repos_url": "https://api.github.com/users/ankit1063/repos",
                    "events_url": "https://api.github.com/users/ankit1063/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/ankit1063/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "html_url": "https://github.com/ankit1063/trl",
                "description": "Train transformer language models with reinforcement learning.",
                "fork": true,
                "url": "https://api.github.com/repos/ankit1063/trl",
                "forks_url": "https://api.github.com/repos/ankit1063/trl/forks",
                "keys_url": "https://api.github.com/repos/ankit1063/trl/keys{/key_id}",
                "collaborators_url": "https://api.github.com/repos/ankit1063/trl/collaborators{/collaborator}",
                "teams_url": "https://api.github.com/repos/ankit1063/trl/teams",
                "hooks_url": "https://api.github.com/repos/ankit1063/trl/hooks",
                "issue_events_url": "https://api.github.com/repos/ankit1063/trl/issues/events{/number}",
                "events_url": "https://api.github.com/repos/ankit1063/trl/events",
                "assignees_url": "https://api.github.com/repos/ankit1063/trl/assignees{/user}",
                "branches_url": "https://api.github.com/repos/ankit1063/trl/branches{/branch}",
                "tags_url": "https://api.github.com/repos/ankit1063/trl/tags",
                "blobs_url": "https://api.github.com/repos/ankit1063/trl/git/blobs{/sha}",
                "git_tags_url": "https://api.github.com/repos/ankit1063/trl/git/tags{/sha}",
                "git_refs_url": "https://api.github.com/repos/ankit1063/trl/git/refs{/sha}",
                "trees_url": "https://api.github.com/repos/ankit1063/trl/git/trees{/sha}",
                "statuses_url": "https://api.github.com/repos/ankit1063/trl/statuses/{sha}",
                "languages_url": "https://api.github.com/repos/ankit1063/trl/languages",
                "stargazers_url": "https://api.github.com/repos/ankit1063/trl/stargazers",
                "contributors_url": "https://api.github.com/repos/ankit1063/trl/contributors",
                "subscribers_url": "https://api.github.com/repos/ankit1063/trl/subscribers",
                "subscription_url": "https://api.github.com/repos/ankit1063/trl/subscription",
                "commits_url": "https://api.github.com/repos/ankit1063/trl/commits{/sha}",
                "git_commits_url": "https://api.github.com/repos/ankit1063/trl/git/commits{/sha}",
                "comments_url": "https://api.github.com/repos/ankit1063/trl/comments{/number}",
                "issue_comment_url": "https://api.github.com/repos/ankit1063/trl/issues/comments{/number}",
                "contents_url": "https://api.github.com/repos/ankit1063/trl/contents/{+path}",
                "compare_url": "https://api.github.com/repos/ankit1063/trl/compare/{base}...{head}",
                "merges_url": "https://api.github.com/repos/ankit1063/trl/merges",
                "archive_url": "https://api.github.com/repos/ankit1063/trl/{archive_format}{/ref}",
                "downloads_url": "https://api.github.com/repos/ankit1063/trl/downloads",
                "issues_url": "https://api.github.com/repos/ankit1063/trl/issues{/number}",
                "pulls_url": "https://api.github.com/repos/ankit1063/trl/pulls{/number}",
                "milestones_url": "https://api.github.com/repos/ankit1063/trl/milestones{/number}",
                "notifications_url": "https://api.github.com/repos/ankit1063/trl/notifications{?since,all,participating}",
                "labels_url": "https://api.github.com/repos/ankit1063/trl/labels{/name}",
                "releases_url": "https://api.github.com/repos/ankit1063/trl/releases{/id}",
                "deployments_url": "https://api.github.com/repos/ankit1063/trl/deployments",
                "created_at": "2023-10-26T15:31:31Z",
                "updated_at": "2023-10-26T15:31:31Z",
                "pushed_at": "2023-10-26T05:07:39Z",
                "git_url": "git://github.com/ankit1063/trl.git",
                "ssh_url": "git@github.com:ankit1063/trl.git",
                "clone_url": "https://github.com/ankit1063/trl.git",
                "svn_url": "https://github.com/ankit1063/trl",
                "homepage": "http://hf.co/docs/trl",
                "size": 5860,
                "stargazers_count": 0,
                "watchers_count": 0,
                "language": null,
                "has_issues": false,
                "has_projects": true,
                "has_downloads": true,
                "has_wiki": true,
                "has_pages": false,
                "has_discussions": false,
                "forks_count": 0,
                "mirror_url": null,
                "archived": false,
                "disabled": false,
                "open_issues_count": 0,
                "license": null,
                "allow_forking": true,
                "is_template": false,
                "web_commit_signoff_required": false,
                "topics": [],
                "visibility": "public",
                "forks": 0,
                "open_issues": 0,
                "watchers": 0,
                "default_branch": "main",
                "public": true
            }
        },
        "public": true,
        "created_at": "2023-10-26T15:31:32Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32873722033",
        "type": "WatchEvent",
        "actor": {
            "id": 41106123,
            "login": "ankit1063",
            "display_login": "ankit1063",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ankit1063",
            "avatar_url": "https://avatars.githubusercontent.com/u/41106123?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T15:31:27Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32873185045",
        "type": "WatchEvent",
        "actor": {
            "id": 81462200,
            "login": "XvHaidong",
            "display_login": "XvHaidong",
            "gravatar_id": "",
            "url": "https://api.github.com/users/XvHaidong",
            "avatar_url": "https://avatars.githubusercontent.com/u/81462200?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T15:14:20Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32870544493",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 13449847,
            "login": "Ali1858",
            "display_login": "Ali1858",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Ali1858",
            "avatar_url": "https://avatars.githubusercontent.com/u/13449847?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/899",
                "repository_url": "https://api.github.com/repos/huggingface/trl",
                "labels_url": "https://api.github.com/repos/huggingface/trl/issues/899/labels{/name}",
                "comments_url": "https://api.github.com/repos/huggingface/trl/issues/899/comments",
                "events_url": "https://api.github.com/repos/huggingface/trl/issues/899/events",
                "html_url": "https://github.com/huggingface/trl/issues/899",
                "id": 1955075958,
                "node_id": "I_kwDODu56-850iBd2",
                "number": 899,
                "title": "OOM error while PPO training Llama-2-7B model",
                "user": {
                    "login": "Ali1858",
                    "id": 13449847,
                    "node_id": "MDQ6VXNlcjEzNDQ5ODQ3",
                    "avatar_url": "https://avatars.githubusercontent.com/u/13449847?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/Ali1858",
                    "html_url": "https://github.com/Ali1858",
                    "followers_url": "https://api.github.com/users/Ali1858/followers",
                    "following_url": "https://api.github.com/users/Ali1858/following{/other_user}",
                    "gists_url": "https://api.github.com/users/Ali1858/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/Ali1858/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/Ali1858/subscriptions",
                    "organizations_url": "https://api.github.com/users/Ali1858/orgs",
                    "repos_url": "https://api.github.com/users/Ali1858/repos",
                    "events_url": "https://api.github.com/users/Ali1858/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/Ali1858/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "open",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 6,
                "created_at": "2023-10-20T22:18:32Z",
                "updated_at": "2023-10-26T13:56:38Z",
                "closed_at": null,
                "author_association": "NONE",
                "active_lock_reason": null,
                "body": "Hi\r\n\r\nI am getting OOM while doing PPO fine-tuning. I am fine-tuning the Llama-2-7B on A100 (40GB VRAM) and the reward model (also Llama-2-7B) is kept on a separate A100 (10GB VRAM) for inference. I have tried keeping batch_size, mini_batch_size, and gradient_accumulation all at 1, then also it's throwing OOM with a sudden spike in memory.\r\n\r\nImplementing the suggestion of gradient checkpointing throws an AttributeError: `AutoModelForCausalLMWithValueHead` object has no attribute 'is_peft_model'. Can you tell me how you pass the Lora config and enable checkpointing?\r\n\r\nFollowing code give me error:\r\n\r\n```python\r\n    lora_config = LoraConfig(\r\n        r=64,\r\n        lora_alpha=16,\r\n        lora_dropout=0.1,\r\n        bias=\"none\",\r\n        task_type=\"CAUSAL_LM\",\r\n    )\r\n    model_args = {\r\n        \"torch_dtype\": dtype,\r\n        \"quantization_config\": BitsAndBytesConfig(\r\n            load_in_4bit=True,\r\n            bnb_4bit_quant_type=\"nf4\",\r\n            bnb_4bit_compute_dtype=dtype,\r\n            bnb_4bit_use_double_quant=True,\r\n            ),\r\n        \"cache_dir\": CACHE_DIR,\r\n        \"device_map\": device_map,\r\n    }\r\n\r\n    base_model =  transformers.AutoModelForCausalLM.from_pretrained(\r\n        conf.model_name, trust_remote_code=True, **model_args\r\n    )\r\n    base_model.gradient_checkpointing_enable()\r\n\r\n    base_model = AutoModelForCausalLMWithValueHead(base_model, trust_remote_code=True,peft_config= lora_config)\r\n```\r\nPPO training loop.\r\nSince the data loader set batch_size to batch_size, I am generating one response at a time to avoid OOM.\r\n\r\n```python\r\nfor epoch, batch in tqdm(enumerate(ppo_trainer.dataloader)):\r\n        query_tensor = batch[\"input_ids\"]\r\n        \r\n        # Initialize empty lists to store responses and rewards\r\n        response_tensors = []\r\n        responses = []\r\n        rewards = []\r\n\r\n        # Iterate through each query in the query_tensor\r\n        for idx in range(len(query_tensor)):\r\n\r\n            single_response_tensor = ppo_trainer.generate(\r\n                [query_tensor[idx]],\r\n                return_prompt=False,\r\n                # length_sampler=512\r\n                **generation_kwargs,\r\n            )\r\n            \r\n            response = tokenizer.decode(single_response_tensor[0], skip_special_tokens=True)\r\n            responses.append(response)\r\n\r\n            # Prepare input for reward model\r\n            text = batch[\"query\"][idx] + response\r\n            inputs = tokenizer(text, max_length=2048, padding=True, truncation=True, return_tensors=\"pt\").to(base_reward_model.device)\r\n            \r\n            \r\n            reward = compute_reward_score(inputs,base_reward_model,conf)\r\n            reward = reward[0][0]\r\n\r\n            # Append the generated response tensor and computed reward\r\n            response_tensors.append(single_response_tensor[0])\r\n            rewards.append(reward)\r\n        \r\n        # Convert lists to tensors\r\n        # response_tensors = torch.cat(response_tensors, dim=0) \r\n        batch[\"response\"] = responses\r\n                \r\n        #Run PPO step\r\n        stats = ppo_trainer.step(query_tensor, response_tensors, rewards)\r\n\r\n        rewards = [r.float() if r.dtype == torch.bfloat16 else r for r in rewards]\r\n        if epoch%conf.log_step==0:\r\n            ppo_trainer.log_stats(stats, batch, rewards)\r\n        \r\n        if epoch > 0 and epoch%conf.save_steps==0:\r\n            ppo_trainer.save_pretrained(save_dir + f\"/checkpoint_{epoch}\")\r\n```\r\nCan you please tell me what I am doing wrong?",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/899/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/huggingface/trl/issues/899/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1781181743",
                "html_url": "https://github.com/huggingface/trl/issues/899#issuecomment-1781181743",
                "issue_url": "https://api.github.com/repos/huggingface/trl/issues/899",
                "id": 1781181743,
                "node_id": "IC_kwDODu56-85qKq0v",
                "user": {
                    "login": "Ali1858",
                    "id": 13449847,
                    "node_id": "MDQ6VXNlcjEzNDQ5ODQ3",
                    "avatar_url": "https://avatars.githubusercontent.com/u/13449847?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/Ali1858",
                    "html_url": "https://github.com/Ali1858",
                    "followers_url": "https://api.github.com/users/Ali1858/followers",
                    "following_url": "https://api.github.com/users/Ali1858/following{/other_user}",
                    "gists_url": "https://api.github.com/users/Ali1858/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/Ali1858/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/Ali1858/subscriptions",
                    "organizations_url": "https://api.github.com/users/Ali1858/orgs",
                    "repos_url": "https://api.github.com/users/Ali1858/repos",
                    "events_url": "https://api.github.com/users/Ali1858/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/Ali1858/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2023-10-26T13:56:38Z",
                "updated_at": "2023-10-26T13:56:38Z",
                "author_association": "NONE",
                "body": "Yes I am already using QLora with the following config\r\n\r\n```python\r\ndtype =  torch.bfloat16  \r\nlora_config = LoraConfig(\r\n        r=64,\r\n        lora_alpha=16,\r\n        lora_dropout=0.1,\r\n        bias=\"none\",\r\n        task_type=\"CAUSAL_LM\",\r\n        target_modules=[\"q_proj\",\r\n         \"down_proj\",\r\n         \"gate_proj\",\r\n         \"o_proj\",\r\n         \"k_proj\",\r\n         \"v_proj\",\r\n         \"up_proj\"\r\n         ]\r\n    )\r\nmodel_args = {\r\n        \"torch_dtype\": dtype,\r\n        \"quantization_config\": BitsAndBytesConfig(\r\n            load_in_4bit=True,\r\n            bnb_4bit_quant_type=\"nf4\",\r\n            bnb_4bit_compute_dtype=dtype,\r\n            bnb_4bit_use_double_quant=True,\r\n            ),\r\n        \"cache_dir\": CACHE_DIR,\r\n        \"device_map\": device_map,\r\n        \"load_in_4bit\":True\r\n    }\r\n```",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1781181743/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2023-10-26T13:56:39Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32869866878",
        "type": "WatchEvent",
        "actor": {
            "id": 126769294,
            "login": "L-2532696",
            "display_login": "L-2532696",
            "gravatar_id": "",
            "url": "https://api.github.com/users/L-2532696",
            "avatar_url": "https://avatars.githubusercontent.com/u/126769294?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T13:36:34Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32869371823",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 30946547,
            "login": "abhilash1910",
            "display_login": "abhilash1910",
            "gravatar_id": "",
            "url": "https://api.github.com/users/abhilash1910",
            "avatar_url": "https://avatars.githubusercontent.com/u/30946547?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/839",
                "repository_url": "https://api.github.com/repos/huggingface/trl",
                "labels_url": "https://api.github.com/repos/huggingface/trl/issues/839/labels{/name}",
                "comments_url": "https://api.github.com/repos/huggingface/trl/issues/839/comments",
                "events_url": "https://api.github.com/repos/huggingface/trl/issues/839/events",
                "html_url": "https://github.com/huggingface/trl/pull/839",
                "id": 1929720628,
                "node_id": "PR_kwDODu56-85cFhhO",
                "number": 839,
                "title": "[Feature] Enable Intel XPU  support",
                "user": {
                    "login": "abhilash1910",
                    "id": 30946547,
                    "node_id": "MDQ6VXNlcjMwOTQ2NTQ3",
                    "avatar_url": "https://avatars.githubusercontent.com/u/30946547?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/abhilash1910",
                    "html_url": "https://github.com/abhilash1910",
                    "followers_url": "https://api.github.com/users/abhilash1910/followers",
                    "following_url": "https://api.github.com/users/abhilash1910/following{/other_user}",
                    "gists_url": "https://api.github.com/users/abhilash1910/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/abhilash1910/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/abhilash1910/subscriptions",
                    "organizations_url": "https://api.github.com/users/abhilash1910/orgs",
                    "repos_url": "https://api.github.com/users/abhilash1910/repos",
                    "events_url": "https://api.github.com/users/abhilash1910/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/abhilash1910/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "open",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 20,
                "created_at": "2023-10-06T08:53:45Z",
                "updated_at": "2023-10-26T13:22:04Z",
                "closed_at": null,
                "author_association": "NONE",
                "active_lock_reason": null,
                "draft": false,
                "pull_request": {
                    "url": "https://api.github.com/repos/huggingface/trl/pulls/839",
                    "html_url": "https://github.com/huggingface/trl/pull/839",
                    "diff_url": "https://github.com/huggingface/trl/pull/839.diff",
                    "patch_url": "https://github.com/huggingface/trl/pull/839.patch",
                    "merged_at": null
                },
                "body": "Thanks for creating this library. In our effort to streamline huggingface on Intel devices,  this PR is an important step . With support already enabled in peft/accelerate and transformers this would be a good addition to run TRL out of the box on our devices.\r\ncc @younesbelkada @pacman100  ",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/839/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/huggingface/trl/issues/839/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1781115765",
                "html_url": "https://github.com/huggingface/trl/pull/839#issuecomment-1781115765",
                "issue_url": "https://api.github.com/repos/huggingface/trl/issues/839",
                "id": 1781115765,
                "node_id": "IC_kwDODu56-85qKat1",
                "user": {
                    "login": "abhilash1910",
                    "id": 30946547,
                    "node_id": "MDQ6VXNlcjMwOTQ2NTQ3",
                    "avatar_url": "https://avatars.githubusercontent.com/u/30946547?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/abhilash1910",
                    "html_url": "https://github.com/abhilash1910",
                    "followers_url": "https://api.github.com/users/abhilash1910/followers",
                    "following_url": "https://api.github.com/users/abhilash1910/following{/other_user}",
                    "gists_url": "https://api.github.com/users/abhilash1910/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/abhilash1910/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/abhilash1910/subscriptions",
                    "organizations_url": "https://api.github.com/users/abhilash1910/orgs",
                    "repos_url": "https://api.github.com/users/abhilash1910/repos",
                    "events_url": "https://api.github.com/users/abhilash1910/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/abhilash1910/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2023-10-26T13:22:03Z",
                "updated_at": "2023-10-26T13:22:03Z",
                "author_association": "NONE",
                "body": "@lvwerra  Unfortunately I did not save the entire run log for wandb (for the previous run), I retook a snap again for 6 iters for the ppo mean & the returns:\r\n<img width=\"653\" alt=\"image\" src=\"https://github.com/huggingface/trl/assets/30946547/6791720f-073c-47cc-8ad0-033d8ec5bb38\">\r\nIt seems like it is converging .policy kl curve is something I am looking at : \r\n<img width=\"285\" alt=\"image\" src=\"https://github.com/huggingface/trl/assets/30946547/67c0d8c6-72a0-4135-8341-1b5498d56efa\"> which seems to be going as it should. Let me know if this seems ok ? Thanks\r\n",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1781115765/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2023-10-26T13:22:04Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32868695603",
        "type": "WatchEvent",
        "actor": {
            "id": 28992970,
            "login": "aicanhelp",
            "display_login": "aicanhelp",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aicanhelp",
            "avatar_url": "https://avatars.githubusercontent.com/u/28992970?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "started"
        },
        "public": true,
        "created_at": "2023-10-26T13:01:42Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32868255441",
        "type": "ForkEvent",
        "actor": {
            "id": 36058628,
            "login": "sywangyi",
            "display_login": "sywangyi",
            "gravatar_id": "",
            "url": "https://api.github.com/users/sywangyi",
            "avatar_url": "https://avatars.githubusercontent.com/u/36058628?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "forkee": {
                "id": 710309561,
                "node_id": "R_kgDOKlZ2uQ",
                "name": "trl",
                "full_name": "sywangyi/trl",
                "private": false,
                "owner": {
                    "login": "sywangyi",
                    "id": 36058628,
                    "node_id": "MDQ6VXNlcjM2MDU4NjI4",
                    "avatar_url": "https://avatars.githubusercontent.com/u/36058628?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/sywangyi",
                    "html_url": "https://github.com/sywangyi",
                    "followers_url": "https://api.github.com/users/sywangyi/followers",
                    "following_url": "https://api.github.com/users/sywangyi/following{/other_user}",
                    "gists_url": "https://api.github.com/users/sywangyi/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/sywangyi/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/sywangyi/subscriptions",
                    "organizations_url": "https://api.github.com/users/sywangyi/orgs",
                    "repos_url": "https://api.github.com/users/sywangyi/repos",
                    "events_url": "https://api.github.com/users/sywangyi/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/sywangyi/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "html_url": "https://github.com/sywangyi/trl",
                "description": "Train transformer language models with reinforcement learning.",
                "fork": true,
                "url": "https://api.github.com/repos/sywangyi/trl",
                "forks_url": "https://api.github.com/repos/sywangyi/trl/forks",
                "keys_url": "https://api.github.com/repos/sywangyi/trl/keys{/key_id}",
                "collaborators_url": "https://api.github.com/repos/sywangyi/trl/collaborators{/collaborator}",
                "teams_url": "https://api.github.com/repos/sywangyi/trl/teams",
                "hooks_url": "https://api.github.com/repos/sywangyi/trl/hooks",
                "issue_events_url": "https://api.github.com/repos/sywangyi/trl/issues/events{/number}",
                "events_url": "https://api.github.com/repos/sywangyi/trl/events",
                "assignees_url": "https://api.github.com/repos/sywangyi/trl/assignees{/user}",
                "branches_url": "https://api.github.com/repos/sywangyi/trl/branches{/branch}",
                "tags_url": "https://api.github.com/repos/sywangyi/trl/tags",
                "blobs_url": "https://api.github.com/repos/sywangyi/trl/git/blobs{/sha}",
                "git_tags_url": "https://api.github.com/repos/sywangyi/trl/git/tags{/sha}",
                "git_refs_url": "https://api.github.com/repos/sywangyi/trl/git/refs{/sha}",
                "trees_url": "https://api.github.com/repos/sywangyi/trl/git/trees{/sha}",
                "statuses_url": "https://api.github.com/repos/sywangyi/trl/statuses/{sha}",
                "languages_url": "https://api.github.com/repos/sywangyi/trl/languages",
                "stargazers_url": "https://api.github.com/repos/sywangyi/trl/stargazers",
                "contributors_url": "https://api.github.com/repos/sywangyi/trl/contributors",
                "subscribers_url": "https://api.github.com/repos/sywangyi/trl/subscribers",
                "subscription_url": "https://api.github.com/repos/sywangyi/trl/subscription",
                "commits_url": "https://api.github.com/repos/sywangyi/trl/commits{/sha}",
                "git_commits_url": "https://api.github.com/repos/sywangyi/trl/git/commits{/sha}",
                "comments_url": "https://api.github.com/repos/sywangyi/trl/comments{/number}",
                "issue_comment_url": "https://api.github.com/repos/sywangyi/trl/issues/comments{/number}",
                "contents_url": "https://api.github.com/repos/sywangyi/trl/contents/{+path}",
                "compare_url": "https://api.github.com/repos/sywangyi/trl/compare/{base}...{head}",
                "merges_url": "https://api.github.com/repos/sywangyi/trl/merges",
                "archive_url": "https://api.github.com/repos/sywangyi/trl/{archive_format}{/ref}",
                "downloads_url": "https://api.github.com/repos/sywangyi/trl/downloads",
                "issues_url": "https://api.github.com/repos/sywangyi/trl/issues{/number}",
                "pulls_url": "https://api.github.com/repos/sywangyi/trl/pulls{/number}",
                "milestones_url": "https://api.github.com/repos/sywangyi/trl/milestones{/number}",
                "notifications_url": "https://api.github.com/repos/sywangyi/trl/notifications{?since,all,participating}",
                "labels_url": "https://api.github.com/repos/sywangyi/trl/labels{/name}",
                "releases_url": "https://api.github.com/repos/sywangyi/trl/releases{/id}",
                "deployments_url": "https://api.github.com/repos/sywangyi/trl/deployments",
                "created_at": "2023-10-26T12:48:26Z",
                "updated_at": "2023-10-26T12:48:26Z",
                "pushed_at": "2023-10-26T05:07:39Z",
                "git_url": "git://github.com/sywangyi/trl.git",
                "ssh_url": "git@github.com:sywangyi/trl.git",
                "clone_url": "https://github.com/sywangyi/trl.git",
                "svn_url": "https://github.com/sywangyi/trl",
                "homepage": "http://hf.co/docs/trl",
                "size": 5860,
                "stargazers_count": 0,
                "watchers_count": 0,
                "language": null,
                "has_issues": false,
                "has_projects": true,
                "has_downloads": true,
                "has_wiki": true,
                "has_pages": false,
                "has_discussions": false,
                "forks_count": 0,
                "mirror_url": null,
                "archived": false,
                "disabled": false,
                "open_issues_count": 0,
                "license": null,
                "allow_forking": true,
                "is_template": false,
                "web_commit_signoff_required": false,
                "topics": [],
                "visibility": "public",
                "forks": 0,
                "open_issues": 0,
                "watchers": 0,
                "default_branch": "main",
                "public": true
            }
        },
        "public": true,
        "created_at": "2023-10-26T12:48:27Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    },
    {
        "id": "32868217507",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 8264887,
            "login": "lvwerra",
            "display_login": "lvwerra",
            "gravatar_id": "",
            "url": "https://api.github.com/users/lvwerra",
            "avatar_url": "https://avatars.githubusercontent.com/u/8264887?"
        },
        "repo": {
            "id": 250510075,
            "name": "huggingface/trl",
            "url": "https://api.github.com/repos/huggingface/trl"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/839",
                "repository_url": "https://api.github.com/repos/huggingface/trl",
                "labels_url": "https://api.github.com/repos/huggingface/trl/issues/839/labels{/name}",
                "comments_url": "https://api.github.com/repos/huggingface/trl/issues/839/comments",
                "events_url": "https://api.github.com/repos/huggingface/trl/issues/839/events",
                "html_url": "https://github.com/huggingface/trl/pull/839",
                "id": 1929720628,
                "node_id": "PR_kwDODu56-85cFhhO",
                "number": 839,
                "title": "[Feature] Enable Intel XPU  support",
                "user": {
                    "login": "abhilash1910",
                    "id": 30946547,
                    "node_id": "MDQ6VXNlcjMwOTQ2NTQ3",
                    "avatar_url": "https://avatars.githubusercontent.com/u/30946547?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/abhilash1910",
                    "html_url": "https://github.com/abhilash1910",
                    "followers_url": "https://api.github.com/users/abhilash1910/followers",
                    "following_url": "https://api.github.com/users/abhilash1910/following{/other_user}",
                    "gists_url": "https://api.github.com/users/abhilash1910/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/abhilash1910/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/abhilash1910/subscriptions",
                    "organizations_url": "https://api.github.com/users/abhilash1910/orgs",
                    "repos_url": "https://api.github.com/users/abhilash1910/repos",
                    "events_url": "https://api.github.com/users/abhilash1910/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/abhilash1910/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "open",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 19,
                "created_at": "2023-10-06T08:53:45Z",
                "updated_at": "2023-10-26T12:47:14Z",
                "closed_at": null,
                "author_association": "NONE",
                "active_lock_reason": null,
                "draft": false,
                "pull_request": {
                    "url": "https://api.github.com/repos/huggingface/trl/pulls/839",
                    "html_url": "https://github.com/huggingface/trl/pull/839",
                    "diff_url": "https://github.com/huggingface/trl/pull/839.diff",
                    "patch_url": "https://github.com/huggingface/trl/pull/839.patch",
                    "merged_at": null
                },
                "body": "Thanks for creating this library. In our effort to streamline huggingface on Intel devices,  this PR is an important step . With support already enabled in peft/accelerate and transformers this would be a good addition to run TRL out of the box on our devices.\r\ncc @younesbelkada @pacman100  ",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/839/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/huggingface/trl/issues/839/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1781054607",
                "html_url": "https://github.com/huggingface/trl/pull/839#issuecomment-1781054607",
                "issue_url": "https://api.github.com/repos/huggingface/trl/issues/839",
                "id": 1781054607,
                "node_id": "IC_kwDODu56-85qKLyP",
                "user": {
                    "login": "lvwerra",
                    "id": 8264887,
                    "node_id": "MDQ6VXNlcjgyNjQ4ODc=",
                    "avatar_url": "https://avatars.githubusercontent.com/u/8264887?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/lvwerra",
                    "html_url": "https://github.com/lvwerra",
                    "followers_url": "https://api.github.com/users/lvwerra/followers",
                    "following_url": "https://api.github.com/users/lvwerra/following{/other_user}",
                    "gists_url": "https://api.github.com/users/lvwerra/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/lvwerra/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/lvwerra/subscriptions",
                    "organizations_url": "https://api.github.com/users/lvwerra/orgs",
                    "repos_url": "https://api.github.com/users/lvwerra/repos",
                    "events_url": "https://api.github.com/users/lvwerra/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/lvwerra/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2023-10-26T12:47:14Z",
                "updated_at": "2023-10-26T12:47:14Z",
                "author_association": "MEMBER",
                "body": "Hi @abhilash1910, did you still save the training logs? All we want to check is that PPO also converges at the same rate as on the GPU. E.g. the mean reward vs. iteration plot would be helpful. Thank you!",
                "reactions": {
                    "url": "https://api.github.com/repos/huggingface/trl/issues/comments/1781054607/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2023-10-26T12:47:15Z",
        "org": {
            "id": 25720743,
            "login": "huggingface",
            "gravatar_id": "",
            "url": "https://api.github.com/orgs/huggingface",
            "avatar_url": "https://avatars.githubusercontent.com/u/25720743?"
        }
    }
]